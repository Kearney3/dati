name: Deploy Status Check

on:
  workflow_run:
    workflows: ["Deploy to Multiple Platforms"]
    types:
      - completed

jobs:
  check-deploy-status:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Check deployment status
      run: |
        echo "âœ… ä¸»éƒ¨ç½²å·¥ä½œæµå·²å®Œæˆ"
        echo "ğŸ“Š éƒ¨ç½²çŠ¶æ€: ${{ github.event.workflow_run.conclusion }}"
        echo "ğŸ• å®Œæˆæ—¶é—´: ${{ github.event.workflow_run.updated_at }}"
        echo "ğŸ”— å·¥ä½œæµURL: ${{ github.event.workflow_run.html_url }}"
        
    - name: Get deployment information
      uses: actions/github-script@v7
      with:
        script: |
          try {
            const { data: deployments } = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              environment: 'production',
              per_page: 1
            });
            
            if (deployments.length > 0) {
              const latestDeployment = deployments[0];
              console.log(`ğŸš€ æœ€æ–°éƒ¨ç½²ä¿¡æ¯:`);
              console.log(`   - éƒ¨ç½²ID: ${latestDeployment.id}`);
              console.log(`   - åˆ›å»ºæ—¶é—´: ${latestDeployment.created_at}`);
              console.log(`   - ç¯å¢ƒ: ${latestDeployment.environment}`);
              console.log(`   - çŠ¶æ€: ${latestDeployment.state}`);
              
              // è·å–éƒ¨ç½²çŠ¶æ€è¯¦æƒ…
              const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: latestDeployment.id,
                per_page: 1
              });
              
              if (statuses.length > 0) {
                const latestStatus = statuses[0];
                console.log(`   - çŠ¶æ€è¯¦æƒ…: ${latestStatus.state}`);
                if (latestStatus.target_url) {
                  console.log(`   - éƒ¨ç½²URL: ${latestStatus.target_url}`);
                }
              }
            } else {
              console.log("âš ï¸ æœªæ‰¾åˆ°ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è®°å½•");
            }
          } catch (error) {
            console.log("âš ï¸ è·å–éƒ¨ç½²ä¿¡æ¯æ—¶å‡ºé”™:", error.message);
          }
          
    - name: Create deployment summary
      uses: actions/github-script@v7
      if: github.event_name == 'push'
      with:
        script: |
          const summary = `
          ## ğŸš€ éƒ¨ç½²å®ŒæˆæŠ¥å‘Š
          
          **éƒ¨ç½²æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
          **åˆ†æ”¯**: ${context.ref}
          **æäº¤**: ${context.sha.substring(0, 7)}
          **çŠ¶æ€**: âœ… æˆåŠŸ
          
          ### éƒ¨ç½²å¹³å°
          - âœ… GitHub Pages
          - âœ… Vercel (å¦‚æœå·²é…ç½®)
          - âœ… Docker Hub
          
          ### ä¸‹ä¸€æ­¥
          - è®¿é—®éƒ¨ç½²çš„åº”ç”¨è¿›è¡Œæµ‹è¯•
          - æ£€æŸ¥å„å¹³å°çš„éƒ¨ç½²çŠ¶æ€
          - å¦‚æœ‰é—®é¢˜è¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—
          `;
          
          // åˆ›å»ºéƒ¨ç½²æ€»ç»“è¯„è®º
          try {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
          } catch (error) {
            console.log("æ— æ³•åˆ›å»ºè¯„è®ºï¼Œå¯èƒ½æ˜¯éPRæ¨é€");
          }
          
    - name: Notify deployment completion
      run: |
        echo "ğŸ‰ éƒ¨ç½²æµç¨‹ç›‘æ§å®Œæˆ"
        echo "ğŸ“‹ æ‰€æœ‰éƒ¨ç½²ä»»åŠ¡å·²æˆåŠŸæ‰§è¡Œ"
        echo "ğŸ” è¯·æ£€æŸ¥å„å¹³å°çš„éƒ¨ç½²çŠ¶æ€"
