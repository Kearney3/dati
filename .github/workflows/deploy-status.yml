name: Deploy Status Check

on:
  workflow_run:
    workflows: ["Deploy to Multiple Platforms"]
    types:
      - completed

jobs:
  check-deploy-status:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Check deployment status
      run: |
        echo "✅ 主部署工作流已完成"
        echo "📊 部署状态: ${{ github.event.workflow_run.conclusion }}"
        echo "🕐 完成时间: ${{ github.event.workflow_run.updated_at }}"
        echo "🔗 工作流URL: ${{ github.event.workflow_run.html_url }}"
        
    - name: Get deployment information
      uses: actions/github-script@v7
      with:
        script: |
          try {
            const { data: deployments } = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              environment: 'production',
              per_page: 1
            });
            
            if (deployments.length > 0) {
              const latestDeployment = deployments[0];
              console.log(`🚀 最新部署信息:`);
              console.log(`   - 部署ID: ${latestDeployment.id}`);
              console.log(`   - 创建时间: ${latestDeployment.created_at}`);
              console.log(`   - 环境: ${latestDeployment.environment}`);
              console.log(`   - 状态: ${latestDeployment.state}`);
              
              // 获取部署状态详情
              const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: latestDeployment.id,
                per_page: 1
              });
              
              if (statuses.length > 0) {
                const latestStatus = statuses[0];
                console.log(`   - 状态详情: ${latestStatus.state}`);
                if (latestStatus.target_url) {
                  console.log(`   - 部署URL: ${latestStatus.target_url}`);
                }
              }
            } else {
              console.log("⚠️ 未找到生产环境部署记录");
            }
          } catch (error) {
            console.log("⚠️ 获取部署信息时出错:", error.message);
          }
          
    - name: Create deployment summary
      uses: actions/github-script@v7
      if: github.event_name == 'push'
      with:
        script: |
          const summary = `
          ## 🚀 部署完成报告
          
          **部署时间**: ${new Date().toLocaleString('zh-CN')}
          **分支**: ${context.ref}
          **提交**: ${context.sha.substring(0, 7)}
          **状态**: ✅ 成功
          
          ### 部署平台
          - ✅ GitHub Pages
          - ✅ Vercel (如果已配置)
          - ✅ Docker Hub
          
          ### 下一步
          - 访问部署的应用进行测试
          - 检查各平台的部署状态
          - 如有问题请查看工作流日志
          `;
          
          // 创建部署总结评论
          try {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
          } catch (error) {
            console.log("无法创建评论，可能是非PR推送");
          }
          
    - name: Notify deployment completion
      run: |
        echo "🎉 部署流程监控完成"
        echo "📋 所有部署任务已成功执行"
        echo "🔍 请检查各平台的部署状态"
